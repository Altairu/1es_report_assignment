% !TEX root = main.tex
%////////////////////////////////////////////////////////
\begin{center}
    \section*{\kintou{2.5zw}{付録}}                      %% ここに番号をつけない
    \vspace*{-2zh}
\end{center}
\addcontentsline{toc}{section}{付録} %% 目次に番号をつけない
\input{appendix.sty}
%////////////////////////////////////////////////////////

作成したプログラムを以下に示す．

\subsubsection{パラメーター導出プログラム}

\begin{lstlisting}
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import linregress

# --- フォント設定（必要に応じて） ---
plt.rcParams['font.family'] = 'Noto Sans JP'

# --- 定数定義 ---
q = 1.602e-19  # 電気素量 [C]
k = 1.381e-23  # ボルツマン定数 [J/K]
T = 300        # 温度 [K]

# --- データ読み込み ---
df = pd.read_csv("nogu.csv", header=1)
df = df.iloc[:, :3]  # 最初の3列（No, V, I）
df.columns = ["No", "V", "I"]
df = df.dropna(subset=["V", "I"])  # 欠損除去

# --- 測定範囲の表示 ---
print(f"電圧範囲: {df['V'].min():.2f} V ～ {df['V'].max():.2f} V")
print(f"電流範囲: {df['I'].min():.2e} A ～ {df['I'].max():.2e} A")

# ----------------------------
# 1. 並列抵抗 Rp（逆方向領域）
# ----------------------------
df_Rp = df[df["V"] < -0.1]
Rp = None
if len(df_Rp) >= 2:
    slope_Rp, _, _, _, _ = linregress(df_Rp["I"].values, df_Rp["V"].values)
    if slope_Rp > 0:
        Rp = slope_Rp
    else:
        print("⚠ Rpが負：測定誤差やばらつきの可能性")

# ----------------------------
# 2. 直列抵抗 Rs（リミッタ前、直線領域）
# ----------------------------
df_Rs = df[(df["V"] > 0.25) & (df["V"] < 0.35) & (df["I"] < 0.002)]
Rs = None
if len(df_Rs) >= 2:
    slope_Rs, _, _, _, _ = linregress(df_Rs["I"].values, df_Rs["V"].values)
    if slope_Rs > 0:
        Rs = slope_Rs
    else:
        print("⚠ Rsが負：直線領域の設定を見直すべき")

# ----------------------------
# 3. 理想係数 n（指数的増加領域）
# ln(I) ≈ ln(Is) + (q / nkT) * V → 傾きから n を計算
# ----------------------------
df_ln = df[(df["V"] > 0.25) & (df["V"] < 0.35) & (df["I"] > 0) & (df["I"] < 0.002)]
n = None
lnI_mA = None
if len(df_ln) >= 2:
    lnI_mA = np.log(df_ln["I"].values * 1000)  # ln(mA)
    slope_ln, _, _, _, _ = linregress(df_ln["V"].values, lnI_mA)
    if slope_ln > 0:
        n = q / (k * T * slope_ln)
    else:
        print("⚠ 指数領域の傾きが負 → n計算不可")

# --- 理想係数 n の変化を計算 ---
voltage_ranges = [(0.15, 0.2),(0.2, 0.25), (0.25, 0.3)]  # 電圧範囲を指定
n_values = []
voltage_centers = []

for v_min, v_max in voltage_ranges:
    df_range = df[(df["V"] > v_min) & (df["V"] < v_max) & (df["I"] > 0)]
    if len(df_range) >= 2:
        try:
            lnI_mA_range = np.log(df_range["I"].values * 1000)  # mAに変換後log
            slope_range, _, _, _, _ = linregress(df_range["V"].values, lnI_mA_range)
            if slope_range > 0:
                n_range = q / (k * T * slope_range)
                # 値が異常に大きい場合は無効化
                if n_range < 10:  # 理想係数 n の範囲は通常 1～2
                    n_values.append(n_range)
                else:
                    print(f"異常値検出: n = {n_range:.2f} (範囲 {v_min}-{v_max})")
                    n_values.append(None)
                voltage_centers.append((v_min + v_max) / 2)
            else:
                print(f"スロープが負またはゼロ: 範囲 {v_min}-{v_max}")
                n_values.append(None)  # スロープが負の場合は無効
                voltage_centers.append((v_min + v_max) / 2)
        except Exception as e:
            print(f"Error in range {v_min}-{v_max}: {e}")
            n_values.append(None)
            voltage_centers.append((v_min + v_max) / 2)
    else:
        print(f"データ不足: 範囲 {v_min}-{v_max}")
        n_values.append(None)
        voltage_centers.append((v_min + v_max) / 2)

# --- 結果出力 ---
print("\n=== ダイオード解析結果（1回目測定） ===")
print(f"並列抵抗 Rp = {Rp:.2f} Ω" if Rp else "Rp：データ不足または異常")
print(f"直列抵抗 Rs = {Rs:.2f} Ω" if Rs else "Rs：データ不足または異常")
print(f"理想係数 n  = {n:.2f}" if n else "n：データ不足または異常")

# --- 結果出力 ---
print("\n=== 理想係数 n の計算結果 ===")
for center, n_val in zip(voltage_centers, n_values):
    if n_val is not None:
        print(f"電圧 {center:.2f} V: n = {n_val:.2f}")
    else:
        print(f"電圧 {center:.2f} V: 計算不可")

# --- グラフ描画 ---
plt.figure(figsize=(10, 4))

# (1) I-V特性（全体）
plt.subplot(1, 2, 1)
plt.plot(df["V"].values, df["I"].values * 1000, 'o-', label="I-V特性")
plt.xlabel("電圧 V [V]")
plt.ylabel("電流 I [mA]")
plt.title("I-V特性（1回目測定）")
plt.grid(True)

# (2) ln(I[mA]) - V 特性（指数的増加領域）
plt.subplot(1, 2, 2)
if lnI_mA is not None:
    plt.plot(df_ln["V"].values, lnI_mA, 'o-', color='orange')
    plt.title("ln(I[mA]) - V 特性（指数領域）")
    plt.ylabel("ln(電流 I [mA])")
else:
    plt.text(0.5, 0.5, "指数領域データなし", transform=plt.gca().transAxes,
             ha='center', va='center')
plt.xlabel("電圧 V [V]")
plt.grid(True)

plt.tight_layout()
plt.show()

# --- グラフ描画（理想係数 n の変化） ---
fig, ax = plt.subplots(figsize=(6, 4))
ax.plot(voltage_centers, n_values, 'o-', label="理想係数 n の変化")
ax.set_title("理想係数 n の電圧依存性")
ax.set_xlabel("電圧 V [V]")
ax.set_ylabel("理想係数 n")
ax.grid(True)
ax.legend()

plt.tight_layout()
plt.show()


\end{lstlisting}
